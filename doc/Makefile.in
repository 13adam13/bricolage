# ****************************************************************
# * Settings                                                     *
# ****************************************************************

# dependencies
SHELL = /bin/sh
POD2HTML = @POD2HTML@
POD2MAN = @POD2MAN@
MKDIR = @MKDIR@
GZIP = @GZIP@
PERL = @PERL@
FIND = @FIND@

# ****************************************************************
# * Other Fields
# ****************************************************************

# directories
LIB = lib
BRIC = ../${LIB}/Bric

# ****************************************************************
# * some things we can figure out here, so we shouldn't 
# * have to mess with the settings all the time
# ****************************************************************

# the sourcefiles
PODFILES = $(shell ${FIND} ${BRIC} -name *.pod 2>/dev/null)
SRCFILES = $(PODFILES)

# suffixes:
.SUFFIXES:
.SUFFIXES: .pod .pl .html .man .man.gz

HTML_TARGETS = $(addprefix html/,$(addsuffix .html,$(basename $(notdir ${SRCFILES}))))
MAN_TARGETS = $(addprefix man/,$(addsuffix .gz,$(basename $(notdir ${SRCFILES}))))
ALL_TARGETS = ${HTML_TARGETS} ${MAN_TARGETS}



# ****************************************************************
# *  RULES follow
# ****************************************************************

all: doc

doc: ${ALL_TARGETS}

html: 
	$(MKDIR) html

man:
	$(MKDIR) man


# ****************************************************************
# * This is a multiple target rule whose effect is to run 
# * pod2[whatever] recursively on the $(LIB) dir.  The whatever
# * is determined by the first prerequisite.
# ****************************************************************
$(HTML_TARGETS): BASE = $(basename $(notdir $@))
$(HTML_TARGETS): ORIG = $(filter %/${BASE}.pod,${SRCFILES})
$(HTML_TARGETS): html
ifdef PERL2HTML
	${PERL2HTML} --bgcolor '#ffffff' --verbosity 1 ${BRIC} html
else
	$(POD2HTML) --podpath=Bric --podroot=../${LIB} --verbose \
	--flush --htmldir=html --recurse --index --infile=$(ORIG) \
	--outfile=$@ --libpods=$(shell echo ${SRCFILES} | tr ' ' ':')
endif
	chmod a+r $@
	${RM} pod2htm*

$(MAN_TARGETS): BASE = $(basename $(notdir $@))
$(MAN_TARGETS): ORIG = $(filter %/${BASE}.pod,${SRCFILES})
$(MAN_TARGETS): man
	$(POD2MAN) $(ORIG) man/$(BASE) 
	${GZIP} man/${BASE}
	chmod a+r $@
	touch $@



clean: 
	$(RM) -r man html

