# ****************************************************************
# * Settings                                                     *
# ****************************************************************

# dependencies
SHELL = /bin/sh
POD2HTML = @POD2HTML@
POD2MAN = @POD2MAN@
MKDIR = @MKDIR@
GZIP = @GZIP@
PERL = @PERL@
FIND = @FIND@

# ****************************************************************
# * Other Fields
# ****************************************************************

# directories
LIB = lib
BRIC = ../${LIB}/Bric

# ****************************************************************
# * some things we can figure out here, so we shouldn't 
# * have to mess with the settings all the time
# ****************************************************************

# the sourcefiles
PODFILES = $(shell ${FIND} ${BRIC} -name *.pod 2>/dev/null)
SRCFILES = $(PODFILES)

# suffixes:
.SUFFIXES:
.SUFFIXES: .pod .pl .html .man .gz

HTML_TARGETS = $(addprefix html/,$(addsuffix .html,$(basename $(notdir ${SRCFILES}))))
MAN_TARGETS = man/bricolage.8.gz man/bricolage-dba.8.gz \
			  man/bricolage-security.8.gz man/bricolage-templates.3.gz \
			  man/bricolage-advTemplages.3.gz man/bricolage-assetEditing.1.gz \
			  man/bricolage-elementAdmin.1.gz man/bricolage-htmlTemplate.3.gz



# ****************************************************************
# *  RULES follow
# ****************************************************************
all: doc
doc: html man
# ****************************************************************
# * This is a multiple target rule whose effect is to run 
# * pod2[whatever] recursively on the $(LIB) dir.  The whatever
# * is determined by the first prerequisite.
# ****************************************************************
html: $(HTML_TARGETS)
$(HTML_TARGETS): html/%.html: ${BRIC}/%.pod
ifdef PERL2HTML
	${PERL2HTML} --bgcolor '#ffffff' --verbosity 1 ${BRIC} html
else
	$(POD2HTML) --podpath=Bric --podroot=../${LIB} --verbose \
	--flush --htmldir=html --recurse --index --infile=$^ \
	--outfile=$@ --libpods=$(shell echo ${SRCFILES} | tr ' ' ':')
endif
	chmod a+r $@
	${RM} pod2htm*

# man pages follow
man: ${MAN_TARGETS}
${MAN_TARGETS}: %.gz: %.man
	${GZIP} -c $^ >$@
man/bricolage.8.man: ${BRIC}/Admin.pod
	${POD2MAN} $^ $@
man/bricolage-dba.8.man: ${BRIC}/DBA.pod
	${POD2MAN} $^ $@
man/bricolage-security.8.man: ${BRIC}/Security.pod
	${POD2MAN} $^ $@
man/bricolage-templates.3.man: ${BRIC}/Templates.pod
	${POD2MAN} $^ $@
man/bricolage-advTemplages.3.man: ${BRIC}/AdvTemplates.pod
	${POD2MAN} $^ $@
man/bricolage-assetEditing.1.man: ${BRIC}/AssetEditing.pod
	${POD2MAN} $^ $@
man/bricolage-elementAdmin.1.man: ${BRIC}/ElementAdmin.pod
	${POD2MAN} $^ $@
man/bricolage-htmlTemplate.3.man: ${BRIC}/HTMLTemplate.pod
	${POD2MAN} $^ $@

clean: 
	$(RM) -f man/*.man man/*.gz html/*.html

