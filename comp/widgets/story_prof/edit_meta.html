<input type="hidden" name="story_prof|update_pc" value="1">

<%perl>
my $rightText = $m->scomp( '/widgets/profile/imageSubmit.mc',
  formName => "theForm",
  callback => $widget . "|trail_cb",
  image    => "view_trail_teal"
) . '&nbsp;';

$rightText .= $m->scomp( '/widgets/profile/imageSubmit.mc',
  formName => "theForm",
  callback => $widget . "|notes_cb",
  image    => %{ $story->get_notes } ? 'note_fill' : "note"
);

$m->comp("/widgets/wrappers/sharky/table_top.mc",
  	 caption => "Information",
	 number  => $num++,
	 rightText => $rightText

);

</%perl>
<table border="0" width="578" cellpadding="0" cellspacing="0">
  <tr>
  <td class="medHeader"><img src="/media/images/spacer.gif" height="18" width="1" /></td>
  <td width="<% $infoIndent %>" align="right" class="medHeader"><span class="label">ID:&nbsp;</span></td>
  <td width="470">&nbsp;<% $id %></td>
  </tr>
  <tr>
  <td bgcolor="white"><img src="/media/images/spacer.gif" width="1" height="1" /></td>
  </tr>
  <tr>
  <td class="medHeader"><img src="/media/images/spacer.gif" height="18" width="1" /></td>
  <td width="<% $infoIndent %>" align="right" class="medHeader"><span class="label">Story Type:&nbsp;</span></td>
  <td width="470">&nbsp;<% $story->get_element_name %></td>
  </tr>
  <tr>
  <td bgcolor="white"><img src="/media/images/spacer.gif" width="1" height="1" /></td>
  </tr>
  <tr>
  <td class="medHeader"><img src="/media/images/spacer.gif" height="18" width="1" /></td>
  <td width="<% $infoIndent %>" align="right" class="medHeader"><span class="label">URI:&nbsp;</span></td>
  <td width="470">&nbsp;<a href="/workflow/profile/preview/story/<% $id %>" class="blackUnderlinedLink" target="preview_<% SERVER_WINDOW_NAME %>"><% $story->get_primary_uri %></a></td>
  </tr>
  <tr>
  <td class="medHeader" colspan=3><img src="/media/images/spacer.gif" height="1" width="1" /></td>
  </tr>
</table>

<% $ieSpacer %>

<& '/widgets/select_object/select_object.mc',
  object        => 'source',
  name			=> "$widget|source__id",
  field			=> 'source_name',
  selected_id   => $story->get_source__id,
  indent	=> 0,
  useTable      => 1,
  disp          => "Source"

&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'priority',
&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'title',
&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'description',
&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'slug',
&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'cover_date',
&>

<% $ieSpacer %>

<& '/widgets/profile/displayFormElement.mc',
   objref => $story,
   key => 'expire_date',
&>


<%perl>

$m->comp("/widgets/wrappers/sharky/table_bottom.mc");

$num = $m->comp('/widgets/container_prof/container_prof.mc', 
	tile		=> $tile,
	tile_type	=> 'story',
	action		=> 'edit',
        title           => 'Content',
        num             => $num,
	start_count	=> 4
);

</%perl>
<%doc>

We might want to actually put the categories in using listManager instead.
The only issue is having the addition argument put up a button instead of a
link. Heres a starter:

<%perl>;$repeatable_opts
my $cats = $story->get_categories;
    $m->comp('/widgets/listManager/listManager.mc',
	     object => 'category',
	     userSort => 0,
	     objs => $cats,
	     title => '%n',
#	     addition => $no_edit ? undef : ['Add', "/admin/profile/action?dest_id=$id"],
#	     constrain => { server_type_id => $id },
	     fields => [qw(name)],
	     profile => undef,
	     select =>  ['Delete', "$widget|delete_cat"],
	     number => $num
	    );
</%perl>
<br />

</%doc>

% $m->comp("/widgets/wrappers/sharky/table_top.mc",
%  	 caption => "Categories",
%	 number  => $num++);

% my @cat = $story->get_categories;
% my $primary = $story->get_primary_category();
% my $p_id    = $primary ? $primary->get_id : '';
% my $rowspan = scalar (@cat) + 2;

<table border=0 cellpadding=0 cellspacing=0 width=578>
<tr>
  <td width=20 class="medHeader"><img src="/media/images/spacer.gif" width="20" height="20" /></td>
  <td width=100 class="medHeader"><span class="label">Name</span></td>
  <td width=1><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=300 class="medHeader"><span class="label">URI</span></td>
  <td width=1><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=80 class="medHeader" align="center"><span class="label">Primary</span></td>
  <td width=1><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=1 rowspan=<% $rowspan %> class="medHeader"><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=75 class="medHeader" align="center"><span class="label" align="center">Delete</span></td>
</tr>


% # BEGIN FOREACH CAT
% my $curr_cats = {};
% foreach (@cat) {
%     $curr_cats->{$_->get_id} = 1;
  <tr>
    <td width=20><img src="/media/images/spacer.gif" width="20" height="20" /></td>
    <td colspan="2"><% $_->get_name %></td>
    <td colspan="2"><% $_->get_uri %></td>
    <td colspan=2 align="center"><input type="radio" name="<% $widget %>|primary_cat" value="<% $_->get_id %>" <% $_->get_id() eq $p_id ? 'CHECKED' : '' %>></td>
    <td align="center">
<& '/widgets/profile/checkbox.mc',
	name => "$widget|delete_cat",
	value => $_->get_id
&>&nbsp;
    </td>
  </tr>
% }
% # END FOREACH CAT


% if (!@cat) {
<tr>
  <td colspan=5>This story has not been assigned to a category.</td>
</tr>
% } else {

<tr>
  <td align="right" colspan=8>&nbsp;</td>
  <td align="center" valign="middle"><input type="image" src="/media/images/delete_red.gif" border=0 vspace=3 name="<% $widget %>|delete_cat_cb" value="Delete Categories"></td>
</tr>
% }

</table>
% # Create the subroutine to exclude categories.
% my $excl_sub = sub { $curr_cats->{$_[0]->get_id} || ! chk_authz($_[0], READ, 1) };

<table border=0 cellpadding=0 cellspacing=0 width=578>
<tr class=medHeader>
  <td align="right" width=<% FIELD_INDENT - 10 %>><&
  '/widgets/profile/imageSubmit.mc',
	     formName => "theForm",
	     callback => "$widget|add_category_cb",
	     image    => "add_category_lgreen",
             vspace   => 3,
             hspace   => 2
&></td>
  <td width=<% 588 - FIELD_INDENT %> valign="middle">
<& '/widgets/select_object/select_object.mc', 
        object => 'category',
	name => "$widget|new_category_id",
        exclude => $excl_sub,
	field => 'uri',
	useTable => 0
&>
  </td>
</tr>
</table>

% $m->comp("/widgets/wrappers/sharky/table_bottom.mc");

% $m->comp("/widgets/wrappers/sharky/table_top.mc",
%  	 caption => "Associations",
%	 number  => $num++);
<table border=0 width=578 cellpadding=0 cellspacing=0>
<tr>
  <td width=20 class="medHeader"><img src="/media/images/spacer.gif" width="20" height="20" /></td>
  <td width=100 class="medHeader"><span class="label">Type</span></td>
  <td width=1><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=376 class="medHeader"><span class="label">&nbsp;Values</span></td>
  <td width=1><img src="/media/images/spacer.gif" width="1" height="20" /></td>
  <td width=80 class="medHeader" align="center"><span class="label">&nbsp;Action</span></td>
</tr>
</table>
<table border=0 width=578 cellpadding=0 cellspacing=0>
<tr>
  <td width=120 align=right valign=top><span class=label>Keywords:&nbsp;</span></td>
  <td width=378 valign=top>
<%perl>
my @keywords;
foreach my $kw ($story->get_keywords) {
    push @keywords, $kw->get_name;
}

$m->out(scalar(@keywords) ? join(", ", @keywords) : "No keywords defined.");

</%perl>
  </td>
  <td width=80 align="center" valign=top><& '/widgets/profile/imageSubmit.mc',
	     formName => "theForm",
	     callback => "$widget|keywords_cb",
	     image    => "edit_lgreen",
             vspace   => 4
&></td>
</tr>
</table>
<table border=0 cellpadding=0 cellspacing=0 width=578>
<tr><td class="medHeader"><img src="/media/images/spacer.gif" width="578" height="1" /></td></tr>
</table>
<table border=0 cellpadding=0 cellspacing=0 width=578>
<tr>
  <td align=right width=120 valign=top><span class=label>Contributors:&nbsp;</span></td>
  <td width=378 valign=top>

<%perl>
my @contribs;
foreach my $cntr ($story->get_contributors) {
    push @contribs,  $cntr->get_name;
}
$m->out(scalar(@contribs) ? join(", ", @contribs) : "No contributors defined.");

</%perl>

  </td>
  <td width=80 align="center" valign=top><&
  '/widgets/profile/imageSubmit.mc',
    formName => "theForm",
    callback => $widget . "|contributors_cb",
    image    => "edit_lgreen",
    vspace   => 3
  &></td>
</tr>
</table>
<%perl>

$m->comp("/widgets/wrappers/sharky/table_bottom.mc");


$m->comp("/widgets/profile/buttonBar.mc",
         widget      => $widget,
	 desks       => $desks,
	 cd          => $cd,
         obj         => $story,
);

</%perl>

<%args>
$widget
</%args>

<%init>
my $story   = get_state_data($widget, 'story');
my $tile    = $story->get_tile();
my $id = $story->get_id;
my $wf_id = get_state_data($widget, 'work_id');
$wf_id = $story->get_workflow_id() unless $wf_id;
my $wf = Bric::Biz::Workflow->lookup( { id => $wf_id });
my $desks = $wf->allowed_desks();
my $cd = $story->get_current_desk();
$cd = $wf->get_start_desk() unless $cd;
my $agent = $m->comp("/widgets/util/detectAgent.mc");
my $infoIndent = ($agent->{browser} eq "Netscape") ? FIELD_INDENT - 5 : FIELD_INDENT + 8;
my $ieSpacer = ($agent->{browser} eq "Internet Explorer") ? qq{<table><tr><td><img src="/media/images/spacer.gif" width=578 height=5 /></td></tr></table>} : '';
my $num = 1;
</%init>
