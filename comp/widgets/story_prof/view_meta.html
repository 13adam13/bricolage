<%perl>
my $note_img = %{ $story->get_notes } ? 'note_fill' : 'note';
my $rightText = qq{
<a href="/workflow/profile/story/view_notes.html?id=} . $id .
 qq{"><img src="/media/images/$note_img.gif" border="0" alt="View Notes" /></a>
    <a href="/workflow/trail/story/}. $id . qq{"><img src="/media/images/} .
  $lang_key  . qq{/view_trail_teal.gif" border="0" alt="View Trail" /></a>
};

$m->comp("/widgets/wrappers/sharky/table_top.mc",
          caption => "Information",
          number  => 1,
          id      => 'storyinfo',
          rightText => $rightText
);
</%perl>
<dl class="viewmeta">
  <dt><%$lang->maketext('UUID')%>:</dt>
  <dd><% $story->get_uuid %></dd>
  <dt><%$lang->maketext('Element')%>:</dt>
  <dd><% $story->get_element_name %></dd>
  <dt><% $lang->maketext('Title') %>:</dt>
  <dd><% $story->get_name %></dd>
  <dt><% $lang->maketext('Description') %>:</dt>
  <dd><% $story->get_description || '&nbsp;' %></dd>
  <dt><% $lang->maketext('Slug') %>:</dt>
  <dd><% $story->get_slug || '&nbsp;' %></dd>
  <dt><% $lang->maketext('URI') %>:</dt>
% if (@ocs == 1) {
  <dd><& '/widgets/profile/preview_link.mc',
          type  => 'story',
          value => $short_story_uri,
          title => $story_uri,
          doc   => $story,
          style => 'blackUnderlinedLink' &>&nbsp;</dd>
% } else {
  <dd>
% if (!($short_story_uri eq $story_uri)) {
        <span class="shortCategory" title="<% $story->get_primary_uri %>"><% $short_story_uri %></span>
% } else {
        <% $story_uri || '&nbsp;' %>
% }
  </dd>
  <dt><% $lang->maketext('Preview in') %>:</dt>
  <dd><% $oc_select %>&nbsp;<%
                           $m->comp('/widgets/profile/preview_link.mc',
                                    type  => 'story',
                                    value => $story->get_primary_uri,
                                    doc   => $story,
                                    oc_js => 'window.document.theForm.ocSelect.options[window.document.theForm.ocSelect.selectedIndex].value',
                                    style => 'blackUnderlinedLink') %></dd>
% }
  <dt><% $lang->maketext('Source') %>:</dt>
  <dd><% Bric::Biz::Org::Source->lookup({ id => $story->get_source__id })->get_source_name %></dd>
% unless (ENABLE_CATEGORY_BROWSER) {
  <dt><% $lang->maketext('Categories') %>:</dt>
  <dd><%perl>
$m->print(join '<br />&nbsp;', sort { $a cmp $b }
          map { $_->get_uri } $story->get_categories);
</%perl></dd>
% }   # unless ENABLE_CATEGORY_BROWSER
  <dt><% $lang->maketext('Cover Date') %>:</dt>
  <dd><% $story->get_cover_date %></dd>
  <dt><% $lang->maketext('Current Version') %>:</dt>
  <dd><% $story->get_current_version %></dd>
  <dt><% $lang->maketext('Published Version') %>:</dt>
  <dd><% $story->get_published_version || '&nbsp;' %></dd>
  <dt><% $lang->maketext('First Published') %>:</dt>
  <dd><% $story->get_first_publish_date || '&nbsp;' %></dd>
  <dt><% $lang->maketext('Last Published') %>:</dt>
  <dd><% $story->get_publish_date || '&nbsp;' %></dd>
  <dt><% $lang->maketext('Expire Date') %>:</dt>
  <dd><% $story->get_expire_date || '&nbsp;' %></dd>
  <dt><% $lang->maketext('Output Channels') %>:</dt>
  <dd><% join ', ', (map { $_->get_name } $story->get_output_channels) %></dd>
</dl>

<& '/widgets/wrappers/sharky/table_bottom.mc' &>

<& '/widgets/container_prof/container_prof.mc',
    tile        => $tile,
    tile_type   => 'story',
    action      => 'view',
    start_count => 4,
    num         => 2
&>

<& '/widgets/wrappers/sharky/table_top.mc',
    caption => "Associations",
    number  => 3
&>
<table class="associations">
<tr class="odd">
  <th><% $lang->maketext('Categories') %>:</th>
  <td><%perl>
my @cats;
foreach my $cat ($story->get_categories) {
    push @cats, $cat->get_name;
}

$m->out(scalar(@cats) ? join(", ", @cats) : $lang->maketext("No categories defined."));
</%perl></td>
</tr>
<tr class="even">
  <th><% $lang->maketext('Keywords') %>:</th>
  <td><%perl>
my @keywords;
foreach my $kw ($story->get_keywords) {
    push @keywords, $kw->get_name;
}

$m->out(scalar(@keywords) ? join(", ", @keywords) : $lang->maketext("No keywords defined."));
</%perl></td>
</tr>
<tr class="odd">
  <th><% $lang->maketext('Contributors') %>:</th>
  <td><%perl>
my @contribs;
foreach my $cntr ($story->get_contributors) {
    push @contribs,  $cntr->get_name;
}
$m->out(scalar(@contribs) ? join(", ", @contribs) : $lang->maketext("No contributors defined."));

</%perl></td>
</tr>
</table>
<& '/widgets/wrappers/sharky/table_bottom.mc' &>

<& '/widgets/profile/button.mc',
    disp      => $lang->maketext("Return"),
    widget    => $widget,
    cb        => 'return_cb',
    button    => 'return_dgreen',
    useTable  => 0 &>


<%args>
$widget
</%args>

<%init>
my $story = get_state_data($widget, 'story');
my $id = $story->get_id;
my $tile  = $story->get_tile();
my $agent = detect_agent();
my $infoIndent = $agent->nav4 ? FIELD_INDENT - 5 : FIELD_INDENT + 8;

my $story_uri = $story->get_primary_uri;
# Truncate long category URLs so they fit in the desk
my $story_uri_len = length($story_uri);
# Each slash should count as 1/2 a char
$story_uri_len -= ($story_uri =~ tr/\///) * .5;
my $short_story_uri = ($story_uri_len > 80) ? substr($story_uri, 0, 30) . "..." . substr($story_uri, -40) : $story_uri;

my @ocs = $story->get_output_channels;
my $primocid = $story->get_primary_oc_id;
my $oc_select = '<select name="ocSelect">';
foreach my $oc (@ocs) {
    my $ocid = $oc->get_id;
    my $selected = $ocid == $primocid ? ' selected' : '';
    $oc_select .= qq{<option value="$ocid"$selected>} . $oc->get_name . '</option>';
}
$oc_select .= '</select>';
</%init>
