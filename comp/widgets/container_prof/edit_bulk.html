<%perl>
# Show the story summary if needed.
if ($show_summary) {
    my $type  = $element->get_object_type;

    # Nab the story from the story_prof widget
    my $asset = get_state_data($type.'_prof', $type);
    $m->comp('/widgets/summary/summary.mc', asset => $asset, number => ++$i);
}
</%perl>
<& /widgets/dialog_box/find.mc,
    field_id  => "$widget|text",
    dialog_id => 'finddialog',
&>
<& '/widgets/wrappers/sharky/table_top.mc',
   caption => $lang->maketext('Bulk Edit [_1]', $element->get_name),
   id      => 'containerprof',
   number  => ++$i,
&>
    <dl class="viewmeta">
        <dt>Element:</dt>
        <dd><% $at->get_name %> <% $show_element_flags->($at) %></dd>
% if (my $fields = $at->get_field_types) {
        <dt>Field Elements:</dt>
        <dd>
%     $m->print(join ', ', map { $_->get_key_name . $show_data_flags->($_) } @$fields);
        </dd>
% }
% if (my $subelems = $at->get_containers) {
        <dt>Container Elements:</dt>
        <dd>
%     $m->print(join ', ', map { $_->get_key_name . $show_element_flags->($_) } @$subelems);
        </dd>
        <dt>Default Field:</dt>
        <dd>
<%perl>;
my $opts = [
    [ '' =>  '' ],
    map  {   [ $_ => $_ ]   }
    sort {     $a cmp $b    }
    map  { $_->get_key_name } $at->get_field_types
];
</%perl>
            <& '/widgets/profile/select.mc',
                    name     => $widget.'|default_field',
                    options  => $opts,
                    value    =>  $def_field,
                    useTable => 0,
            &>
            <& '/widgets/buttons/submit.mc',
                disp    => "Change",
                widget  => $widget,
                cb      => "change_default_field_cb",
                button  => "change_red",
                value   => "Change",
                useTable => 0,
            &>
        </dd>
        <dt><% $lang->maketext('Words') %></dt>
        <dd>
            <& '/widgets/profile/text.mc',
                id      => 'words',
                name    => 'words',
                value   => '',
                useTable    => 0,
            &>
        </dd>
        <dt><% $lang->maketext('Characters') %></dt>
        <dd>
            <& '/widgets/profile/text.mc',
                id      => 'chars',
                name    => 'chars',
                value   => '',
                useTable    => 0,
            &>        
            <button title="<% $lang->maketext('Open the search and replace dialog box') . ' ' . $lang->maketext('(Access Key: [_1])', 'f') %>" accesskey="f" onclick="return openFindDialog(document.getElementById('finddialog'), event);">Search</button>
        </dd>
    </dl>
% }
<& '/widgets/profile/textarea.mc',
    name     => "$widget|text",
    value    => $args->{__use_text__} ? $args->{"$widget|text"} : $element->serialize_to_pod($def_field),
    rows     => 40,
    useTable => 0,
    js       => qq{onkeyup="wordCount(document.theForm, '$widget|text', 'words', 'chars');"},
&>
<script>wordCount(document.theForm, '<% $widget . "|text" %>', 'words', 'chars')</script>
<& '/widgets/wrappers/sharky/table_bottom.mc' &>
<%doc>

<& '/widgets/wrappers/sharky/table_top.mc',
   caption => 'Template Options',
   number  => ++$i,
&>
<table>
<tr>
<th style="text-align: right;">Preserve formatting:</th>
<td><& "/widgets/profile/checkbox.mc",
         checked     => $preserve,
         value       => 1,
         name        => $widget.'|preserve' &>
</td>
<td>
<& '/widgets/buttons/submit.mc',
    disp    => 'Change',
    widget  => $widget,
    cb      => 'change_preserve_cb',
    button  => 'change_red',
    useTable    => 0,
&>
</td>
</tr>
</table>
<& '/widgets/wrappers/sharky/table_bottom.mc' &>
</%doc>
<& '/widgets/buttons/submit.mc',
    disp    => 'Save',
    widget  => $widget,
    cb      => 'bulk_save_and_up_cb',
    button  => 'save_red',
    useTable    => 0,
&>
<& '/widgets/buttons/submit.mc',
    disp    => 'Save and Stay',
    widget  => $widget,
    cb      => 'bulk_save_cb',
    button  => 'save_and_stay_lgreen',
    useTable    => 0,
&>
<& '/widgets/buttons/submit.mc',
    disp    => 'Return without Saving',
    widget  => $widget,
    cb      => 'bulk_up_cb',
    button  => 'cancel_red',
    useTable    => 0,
&>

<%args>
$widget
$show_summary
$args
</%args>
<%init>;
# the element object
my $element       = get_state_data($widget, 'element');
#my $preserve   = get_state_data($widget, 'preserve');
my $i          = 0;
my $at         = $element->get_element_type;
my $def_field  = get_state_data(
    '_tmp_prefs',
    'container_prof.' . $at->get_id . '.def_field'
);
</%init>
<%once>;
my $show_element_flags = sub {
    my $at = shift;
    my @flags;
    push @flags, 'paginated'     if $at->is_paginated;
    push @flags, 'top level'     if $at->is_top_level;
    push @flags, 'fixed uri'     if $at->is_fixed_uri;
    push @flags, 'media'         if $at->is_media;
    push @flags, 'related media' if $at->is_related_media;
    push @flags, 'related story' if $at->is_related_story;

    return '' unless @flags;
    return ' <span class="orangeLink">(' . join(', ', @flags) . ')</span>';
};

my $show_data_flags = sub {
    my $dt = shift;
    my @flags;

    push @flags, 'required'   if $dt->get_required;
    push @flags, 'repeatable' if $dt->get_quantifier;
    return '' unless @flags;
    return ' <span class="orangeLink">(' . join(', ', @flags) . ')</span>';
};
</%once>
