%#--- Arguments ---#

<%args>
$widget
$object
$disp_field
$use_form_tag
$wf
</%args>

%#--- Initialization ---#
<%init>
my $advanced_search = get_state_data($widget, 'advanced_search')
  || get_pref('Default Search');

my $asset_opts = $advanced_search ? {
        '' => $lang->maketext('All Types'),
        map { $_->get_id, $_->get_name }
          Bric::Biz::AssetType->list({
              top_level => 1,
              media     => 0,
              active    => 1,
          })
    } : undef;

my $sites = $c->get('__SITES__');

unless ($sites) {
    $sites = Bric::Biz::Site->list;
    $c->set('__SITES__', $sites);
}

$sites = [grep { chk_authz($_, EDIT, 1) } @$sites];
</%init>

% if ($use_form_tag) {
<form action="<% $r->uri %>" method="post">
% }

<%perl>
my $caption;
unless ($advanced_search) {
    $caption = sprintf(qq{%s ~[<a href="%s?%s|set_advanced_cb=1" class="switchSearch">%s</a>~]},
                   $lang->maketext('Search'),
                   $r->uri,
                   $widget,
                   $lang->maketext('Advanced Search'));
} else {
    $caption = sprintf(qq{%s ~[<a href="%s?%s|unset_advanced_cb=1" class="switchSearch">%s</a>~]},
                   $lang->maketext('Advanced Search'),
                   $r->uri,
                   $widget,
                   $lang->maketext('Simple Search'));
}
$m->comp("/widgets/wrappers/sharky/table_top.mc",
              caption => $caption,
              search  => 1);
</%perl>
<table border=0 cellpadding=0 cellspacing=0>
<tr>
  <td>
            <table>
% unless ($advanced_search) {
              <tr>
                <td>
                  <& /widgets/profile/text.mc, 
                     name     => $widget.'|simple',
                     value    => get_state_data($widget, 'simple') || '',
                     useTable => 0 &>
                </td>
                <td>
%# This hidden field is required to make the form submit when the user hits
%# the "enter" key.
                  <input type="hidden" name="<% $widget %>|story_cb" value="Search" />
                  <input type="image" src="/media/images/<% $lang_key %>/search_red.gif" border=0 name="<% $widget %>|story_cb" value="Search">
                </td>
% } else {
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Title') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc,
                     name     => $widget.'|title',
                     value    => get_state_data($widget, 'title') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('URI') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc,
                     name     => $widget.'|primary_uri',
                     value    => get_state_data($widget, 'primary_uri') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Keyword') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc,
                     name     => $widget.'|keyword',
                     value    => get_state_data($widget, 'keyword') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Text to search') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc, 
                     name     => $widget.'|data_text',
                     value    => get_state_data($widget, 'data_text') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Category URI') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc,
                     name     => $widget.'|category_uri',
                     value    => get_state_data($widget, 'category_uri') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Teaser') %>:</span></td>
                <td>
                  <& /widgets/profile/text.mc, 
                     name     => $widget.'|teaser',
                     value    => get_state_data($widget, 'teaser') || '',
                     useTable => 0 &>
                </td>
              </tr>
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Type') %>:</span></td>
                <td>
                  <& /widgets/profile/select.mc,
                     name     => $widget.'|element__id',
                     value    => get_state_data($widget, 'element__id') || '',
                     options  => $asset_opts,
                     localize => 0,
                     useTable => 0 &>
                </td>
              </tr>
% if (get_pref("Filter by Site Context")) {
<& /widgets/profile/hidden.mc,
   name => "$widget|site_id",
   value => $c->get_user_cx(get_user_id) &>
% } elsif (@$sites > 1) {
              <tr>
                <td align="right"><span class=label><% $lang->maketext('Site') %>:</span></td>
                <td>
                  <& /widgets/profile/select.mc,
                     name     => $widget.'|site_id',
                     value    => get_state_data($widget, 'site_id') || '',
                     options  => [ [ '' => $lang->maketext('All Sites') ],
                                   map { [$_->get_id => $_->get_name] } @$sites ],
                     localize => 0,
                     useTable => 0 &>
                </td>
              </tr>
% }
              <tr>
                <td colspan=2><span class=label><%$lang->maketext('Cover Date')%></span><br />
                  <% $lang->maketext('From') %>: 
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|cover_date_start",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'cover_date_start')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                  <% $lang->maketext('To') %>: 
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|cover_date_end",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'cover_date_end')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                </td>
              </tr>
              <tr>
                <td  colspan=2><span class=label><% $lang->maketext('Publish Date') %></span><br />
                  <% $lang->maketext('From') %>:
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|publish_date_start",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'publish_date_start')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                  <% $lang->maketext('To') %>:
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|publish_date_end",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'publish_date_end')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                </td>
              </tr>
              <tr>
                <td colspan=2><span class=label><% $lang->maketext('Expire Date') %></span><br />
                  <% $lang->maketext('From') %>:
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|expire_date_start",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'expire_date_start')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                  <% $lang->maketext('To') %>:
                  <& '/widgets/select_time/select_time.mc', 
                     base_name  => "$widget|expire_date_end",
                     indent     => 1,
                     no_hour    => 1,
                     no_min     => 1,
                     repopulate => 0,
                     def_date   => get_state_data($widget, 'expire_date_end')||'',
                     compact    => 1,
                     style      => 'inline',
                  &>
                </td>
              </tr>
% } # unless ($advanced_search) {
            </table>
  </td>
</tr>
</table>
<& '/widgets/wrappers/sharky/table_bottom.mc' &>

% if ($advanced_search) {
  <p></p>
  <input type="image" src="/media/images/<% $lang_key %>/search_lgreen.gif" border=0 name="<% $widget %>|story_cb" value="Search">
  <input type="image" src="/media/images/<% $lang_key %>/clear_values_lgreen.gif" border=0 name="<% $widget %>|clear_cb" value="Clear Values">
% }
%#--- Log History ---#
% if ($use_form_tag) {
</form>
% }

