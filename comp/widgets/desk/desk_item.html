<div class="item">
  <div class="head">
% if ($user) {
    <div class="status"><img src="/media/images/encrypted.png" alt="Checked out" title="Checked out by <% $user %>" /></div>
% }
    <div class="version">v.<% $obj->get_version %></div>
    <div class="title"><a href="<% $link %>" title="<% $vlabel %>"><% $name %></a></div>
    <div class="pubstatus need" title="Needs to be Republished">P</div>
<!--    <% $m->comp('publish_status_span.mc',
                sorted => $highlight eq 'name' ? 'sorted' : '',
                asset => $obj) %>-->
  </div>
  <div class="body">
    <dl>
% if ($class ne 'formatting') {
      <dt name="uri" class="<% &$rowtype %>"><% $lang->maketext('Primary URI') %>:</dt>
      <dd name="uri" class="<% &$rowtype %>"><% $uri || '&nbsp;' %></dd>
% }
      <dt name="date" class="<% &$rowtype %>"><% $lang->maketext($date_label) %>:</dt>
      <dd name="date" class="<% &$rowtype %>"><% $date || '&nbsp;' %></dd>
      <dt name="type" class="<% &$rowtype %>"><% $lang->maketext($type_label) %>:</dt>
      <dd name="type" class="<% &$rowtype %>"><% $type || '&nbsp;' %></dd>
      <dt name="id" class="<% &$rowtype %>"><% $lang->maketext($disp) %> ID:</dt>
      <dd name="id" class="<% &$rowtype %>"><% $id || '&nbsp;' %></dd>
      <dt name="site" class="<% &$rowtype %>"><% $lang->maketext('Site') %>:</dt>
      <dd name="site" class="<% &$rowtype %>"><% $site %></dd>
      <dt name="priority" class="<% &$rowtype %>"><% $lang->maketext('Priority') %>:</dt>
      <dd name="priority" class="<% &$rowtype %>"><% $lang->maketext($priors->{$obj->get_priority}) %></dd>
    </dl>
    
    <div class="actions">
    <ul class="action">   
% if ($checked_out) { # checked out by yourself
%   if ($desk_type eq 'workflow') {
      <li><input type="radio" name="actions_<% $id %>" id="actions_checkin_<% $id %>" /><button class="checkin" name="<% $callback_widget %>|checkin_cb" value="<% $aid %>">Check in</button>
      </li>
%   } else {
      <li><input type="radio" name="actions_<% $id %>" id="actions_move_<% $id %>" /> 
          <label for="move_<% $id %>"><% $lang->maketext($mover_label) %></label>
          <& '/widgets/profile/select.mc',
              id       => "move_$id",
              name     => "$widget|next_desk",
              value    => $desk_val,
              options  => $desk_opts,
              useTable => 0 &>
      </li>
%   }
% } elsif (!$user) { # and not checked out by someone else, therefore available
      <li>
        <input type="radio" name="actions_<% $id %>" id="actions_checkout_<% $id %>" /><button class="checkout" name="<% $callback_widget %>|checkout_cb" value="<% $aid %>">Check out</button>
      </li>
% }
      <li>
        <input type="radio" name="actions_<% $id %>" id="actions_delete_<% $id %>" title="<% $lang->maketext('Queue this asset for deletion') %>" /><button class="delete" name="<% $callback_widget %>|delete_cb" value="<% $aid %>" title="<% $lang->maketext('Delete this asset') %>">Delete</button></li>
% # XXX: Why can't you clone from a workflow? -- mroch
% if ($desk_type ne 'workflow' && $class eq 'story') {
      <li><input type="radio" name="actions_<% $id %>" id="actions_clone_<% $id %>" /> <a href="/workflow/profile/workspace/clone/<% $aid %>" title="Clone"><img src="/media/images/copy.png" alt="Clone" /> Clone</a></li>
% }
% if ($can_publish) {
      <li><input type="radio" name="actions_<% $id %>" id="actions_publish_<% $id %>" /> <img src="/media/images/republish.png" alt="Publish" title="Publish" /> Publish</li>
% }
    </ul>
    </div>
<!--
    <ul class="actions">
      <li><a href="<% $ppage . '/' . lc $vlabel %>_notes.html?id=<% $aid %>">Notes</a></li>
      <li><a href="<% $item_url %>"><% $lang->maketext($item_label) %></a></li>
      <li><a href="<% $link %>"><% $lang->maketext($vlabel) %></a></li>
      <li><a href="/workflow/events/<% $class %>/<% $aid %>"><% $lang->maketext('Log') %></a></li>
      <li><% $pub %></li>
    </ul>-->
  </div>
</div>
<%once>;
my $priors = Bric::Biz::Asset->list_priorities;
</%once>
<%args>
$widget => 'desk_asset'
$obj
$highlight
$can_edit
$can_publish
$vlabel => 'View'
$desk_val
$desk_opts
$ppage
$disp
$type
$pub => ''
$aid
$class  => 'story'
$did
$desk_type
$user => undef
$label => undef
$action => undef
</%args>
<%init>;
# Get the ID.
my $id = $obj->get_id;
my $user_id = $obj->get_user__id;

my ($name, $date, $date_label, $type_label, $uri);
my $header_class = 'lightHeader';

my $site = Bric::Biz::Site->lookup({id => $obj->get_site_id})->get_name;
my $alias = '';
my $title_class = 'title';
my $idv_class = 'idv';
if ($class eq 'formatting') {
    $date = $obj->get_deploy_date;
    $date_label = 'Deployed Date';
    $type_label = 'Output Channel';
    $name = $obj->get_uri;
} else {
    $name = $obj->get_name;
    $date = $obj->get_cover_date;
    $date_label = 'Cover Date';
    $type_label = $disp  . ' Type';
    my $co = $vlabel eq 'Edit';
    $alias = 'alias' if $obj->get_alias_id;
    if ($highlight eq 'name') {
        $title_class .= "sorted";
    } elsif ($alias) {
        $title_class .= $alias;
    }
    if ($highlight eq 'id') {
        $idv_class .= "sorted";
    } elsif ($alias) {
        $idv_class .= $alias;
    }
    if ($class eq 'media') {
        $uri = $m->comp('/widgets/profile/preview_link.mc',
                         type  => $class,
                         doc   => $obj,
                         value => $obj->get_uri )
          if $obj->get_file_name;
    } else {
        $uri = $m->comp('/widgets/profile/preview_link.mc',
                         type  => $class,
                         doc   => $obj,
                         value => $obj->get_uri );
    }
    $header_class = 'aliasHeader' if $obj->get_alias_id;
}

my $classes = { $highlight => ' class="sorted"' };
my $rowspan = 5;

my $checked_out = defined $user_id && get_user_id() == $user_id;

my $mover_label = $desk_type ne 'workflow' ? 'Check in to' : 'Move to';

my $callback_widget = ($class eq 'formatting' ? 'tmpl' : $class) . '_prof';

my $link = $ppage . '/' . $aid;
my $item_label = 'Trail';
my $item_url = "/workflow/trail/$class/$aid";
if ($desk_type eq 'workflow') {
    $link .= '?return=' . $did;
    if ($vlabel eq 'Edit') {
        $link .= '&amp;checkout=1';
    }
} else {
    if ($vlabel eq 'Edit') {
        $link .= '?checkout=1';
    }
    if ($class eq 'story') {
        $item_label = 'Clone';
#        $item_url = $r->uri . "?$widget|clone_cb=$aid";
        $item_url = "/workflow/profile/workspace/clone/$aid";
    }
}
</%init>
<%once>
# Create alternating row colors
my $count = 1;
my $rowtype = sub {
    # Print "odd" for 1st and 2nd cell (odd rows), "even" for 3rd and 4th
    $m->out(($count++ <= 2) ? 'odd' : 'even');
    $count = 1 if ($count > 4);
    return;
};
</%once>
<%doc>
###############################################################################

=head1 NAME

/widgets/desk/desk_item.html - Desk Item Presentation.

=head1 VERSION

$LastChangedRevision$

=head1 DATE

$LastChangedDate$

=head1 DESCRIPTION

This element handles the display of individual assets on a desk or workspace.

</%doc>
